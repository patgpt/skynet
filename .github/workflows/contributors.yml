name: Add Contributor

on:
    pull_request_target:
        types: [closed]

permissions:
    contents: write
    pull-requests: write

jobs:
    add-contributor:
        runs-on: ubuntu-latest
        if: github.event.pull_request.merged == true
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: main

            - name: Get PR author
              id: pr-author
              run: |
                  echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

            - name: Check if contributor exists
              id: check
              run: |
                  if grep -q "${{ steps.pr-author.outputs.author }}" CONTRIBUTORS.md; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Add to CONTRIBUTORS.md
              if: steps.check.outputs.exists == 'false'
              run: |
                  # Add contributor to the list
                  sed -i '/## Core Team/a \
                  \
                  - **[${{ steps.pr-author.outputs.author }}](https://github.com/${{ steps.pr-author.outputs.author }})**\
                    - Contributor' CONTRIBUTORS.md

            - name: Commit changes
              if: steps.check.outputs.exists == 'false'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add CONTRIBUTORS.md
                  git commit -m "docs: add @${{ steps.pr-author.outputs.author }} as contributor"
                  git push
